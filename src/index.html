<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日语听力练习 | 日语学习助手</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6', // 主色调-蓝色
                        secondary: '#F97316', // 辅助色-橙色
                        success: '#10B981', // 成功-绿色
                        error: '#EF4444', // 错误-红色
                        accent: '#8B5CF6', // 强调色-紫色
                        particle: '#06B6D4', // 助词按钮主色（青色）- 与其他按钮明显区分
                        particleLight: '#22D3EE', // 助词按钮高亮色
                        shortPlay: '#EC4899', // 短播放按钮主色（粉色）- 全新颜色
                        shortPlayLight: '#F472B6', // 短播放按钮高亮色
                        male: '#2563EB',
                        female: '#DB2777',
                        neutral: {
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            700: '#374151',
                            800: '#1F2937',
                            900: '#111827'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        japanese: ['"Noto Sans JP"', 'sans-serif']
                    },
                }
            }
        }
    </script>

    <!-- 引入Google字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1;
            }
            .correct-char {
                @apply bg-success/20 text-success;
            }
            .incorrect-char {
                @apply bg-error/20 text-error;
            }
            .missing-char {
                @apply bg-error/10 border-b-2 border-error;
            }
            .extra-char {
                @apply bg-orange-100 text-orange-600;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-neutral-800 min-h-screen flex flex-col">
    <!-- 导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-language text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">日语听力练习</h1>
            </div>
            <nav class="hidden md:flex items-center space-x-6">
                <a href="#" class="text-primary font-medium hover:text-primary/80 transition-colors">首页</a>
                <a href="#" class="text-neutral-700 hover:text-primary transition-colors">练习历史</a>
                <a href="#" class="text-neutral-700 hover:text-primary transition-colors">学习资源</a>
                <a href="#" class="text-neutral-700 hover:text-primary transition-colors">关于</a>
            </nav>
            <button class="md:hidden text-neutral-700 focus:outline-none" id="mobile-menu-button">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>
        <!-- 移动端菜单 -->
        <div class="md:hidden hidden bg-white shadow-md absolute w-full" id="mobile-menu">
            <div class="container mx-auto px-4 py-3 flex flex-col space-y-3">
                <a href="#" class="text-primary font-medium py-2 hover:bg-gray-50 px-2 rounded">首页</a>
                <a href="#" class="text-neutral-700 py-2 hover:bg-gray-50 px-2 rounded">练习历史</a>
                <a href="#" class="text-neutral-700 py-2 hover:bg-gray-50 px-2 rounded">学习资源</a>
                <a href="#" class="text-neutral-700 py-2 hover:bg-gray-50 px-2 rounded">关于</a>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- 页面介绍 -->
        <section class="mb-10 text-center max-w-3xl mx-auto">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-neutral-800 mb-4 text-shadow">提升你的日语听力</h2>
            <p class="text-neutral-700 text-lg mb-6">听日语句子，尝试输入你听到的内容，检查答案后可针对性播放错误部分的语音，高效纠正问题。</p>
            <div class="w-20 h-1 bg-gradient-to-r from-primary to-secondary mx-auto rounded-full"></div>
        </section>

        <!-- 文本输入区域 -->
        <section class="mb-12 bg-white rounded-xl shadow-md p-6 md:p-8 max-w-4xl mx-auto transform transition-all duration-500 hover:shadow-lg">
            <h3 class="text-xl font-semibold mb-6 flex items-center">
                <i class="fa fa-pencil-square-o text-primary mr-2"></i>输入文本内容
            </h3>

            <div class="space-y-6">
                <!-- 混合输入区域 -->
                <div>
                    <label for="mixed-text" class="block text-sm font-medium text-neutral-700 mb-2">输入日语文本</label>
                    <textarea
                        id="mixed-text"
                        rows="10"
                        class="w-full px-4 py-3 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none text-lg"
                        placeholder="请输入日语文本，例如：
電話で女の学生と男の学生が話しています。男の学生は明日何をしなければなりませんか。
女：もしもし、伊藤君、私田中だけど。明日のサークルのミーティングが急用で出られなくなっちゃったから代わりに仕切ってくれない？
男：はい、わかりました。何か特別に準備することはありますか？"></textarea>
                    <p class="mt-1 text-sm text-neutral-500"><i class="fa fa-info-circle mr-1"></i> 系统会按句号自动断句，并识别性别标识（如"女："、"男："）</p>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 justify-end pt-4">
                    <button
                        id="clear-button"
                        class="px-6 py-2 border border-neutral-300 rounded-lg text-neutral-700 hover:bg-neutral-100 transition-all flex items-center justify-center"
                    >
                        <i class="fa fa-eraser mr-2"></i>清空
                    </button>
                    <button
                        id="process-button"
                        class="px-6 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg shadow-sm hover:shadow transition-all flex items-center justify-center font-medium"
                    >
                        <i class="fa fa-magic mr-2"></i>处理文本
                    </button>
                </div>
            </div>
        </section>

        <!-- 结果显示区域 -->
        <section id="results-section" class="max-w-4xl mx-auto hidden">
            <div id="practice-content" class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold flex items-center">
                    <i class="fa fa-list-alt text-primary mr-2"></i>练习内容
                </h3>
                <div class="text-sm text-neutral-600">
                    <span id="sentence-count">0</span> 组句子
                </div>
            </div>

            <!-- 句子列表 -->
            <div id="sentences-container" class="space-y-8">
                <!-- 句子卡片会通过JavaScript动态生成 -->
            </div>
        </section>

        <!-- 空状态提示 -->
        <section id="empty-state" class="max-w-4xl mx-auto py-16 text-center hidden">
            <div class="bg-white rounded-xl p-8 shadow-sm">
                <i class="fa fa-file-text-o text-5xl text-neutral-300 mb-4"></i>
                <h3 class="text-xl font-medium text-neutral-700 mb-2">还没有处理的文本</h3>
                <p class="text-neutral-500 mb-6">请在上方交替输入日语和中文内容，然后点击"处理文本"按钮开始练习</p>
                <button
                    id="empty-state-process-button"
                    class="px-6 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg shadow-sm hover:shadow transition-all"
                >
                    开始练习
                </button>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-neutral-800 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center justify-center md:justify-start">
                        <i class="fa fa-language text-primary text-xl mr-2"></i>
                        <span class="font-bold">日语听力练习</span>
                    </div>
                    <p class="text-neutral-400 text-sm mt-2 text-center md:text-left">提升你的日语听力能力</p>
                </div>

                <div class="flex space-x-6">
                    <a href="#" class="text-neutral-400 hover:text-white transition-colors">
                        <i class="fa fa-github text-xl"></i>
                    </a>
                    <a href="#" class="text-neutral-400 hover:text-white transition-colors">
                        <i class="fa fa-twitter text-xl"></i>
                    </a>
                    <a href="#" class="text-neutral-400 hover:text-white transition-colors">
                        <i class="fa fa-envelope text-xl"></i>
                    </a>
                </div>
            </div>

            <div class="border-t border-neutral-700 mt-6 pt-6 text-center text-neutral-500 text-sm">
                &copy; 2023 日语听力练习 | 一个帮助你提升日语听力的工具
            </div>
        </div>
    </footer>

    <!-- 编辑句子的模态框 -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-lg">
            <div class="p-6 border-b border-neutral-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-neutral-800">编辑句子</h3>
                    <button id="close-modal" class="text-neutral-500 hover:text-neutral-800">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <input type="hidden" id="edit-sentence-index">

                <div class="mb-4">
                    <label for="edit-gender" class="block text-sm font-medium text-neutral-700 mb-1">性别</label>
                    <select id="edit-gender" class="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary">
                        <option value="">无</option>
                        <option value="male">男性</option>
                        <option value="female">女性</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="edit-japanese" class="block text-sm font-medium text-neutral-700 mb-1">日语句子</label>
                    <textarea id="edit-japanese" rows="3" class="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary font-japanese"></textarea>
                </div>

                <div>
                    <label for="edit-chinese" class="block text-sm font-medium text-neutral-700 mb-1">中文翻译</label>
                    <textarea id="edit-chinese" rows="3" class="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary"></textarea>
                </div>
            </div>
            <div class="p-4 bg-neutral-50 rounded-b-xl flex justify-end gap-3">
                <button id="cancel-edit" class="px-4 py-2 border border-neutral-300 rounded-lg text-neutral-700 hover:bg-neutral-100 transition-all">
                    取消
                </button>
                <button id="save-edit" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg shadow-sm hover:shadow transition-all">
                    保存
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 日语常用助词列表
        const japaneseParticles = ['は', 'が', 'を', 'に', 'で', 'と', 'から', 'まで', 'へ', 'の', 'より', 'や', 'か', 'も', 'ね', 'よ', 'って', 'な', 'だ', 'です', 'ます'];

        // DOM元素
        const mixedTextarea = document.getElementById('mixed-text');
        const processButton = document.getElementById('process-button');
        const clearButton = document.getElementById('clear-button');
        const resultsSection = document.getElementById('results-section');
        const sentencesContainer = document.getElementById('sentences-container');
        const emptyState = document.getElementById('empty-state');
        const emptyStateProcessButton = document.getElementById('empty-state-process-button');
        const sentenceCountElement = document.getElementById('sentence-count');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const navbar = document.getElementById('navbar');

        // 编辑模态框元素
        const editModal = document.getElementById('edit-modal');
        const closeModal = document.getElementById('close-modal');
        const cancelEdit = document.getElementById('cancel-edit');
        const saveEdit = document.getElementById('save-edit');
        const editSentenceIndex = document.getElementById('edit-sentence-index');
        const editGender = document.getElementById('edit-gender');
        const editJapanese = document.getElementById('edit-japanese');
        const editChinese = document.getElementById('edit-chinese');

        // 存储句子数据，用于错误定位播放
        let sentenceData = [];
        let chineseSentences = [];

        // 初始化页面状态
        updateEmptyState();

        // 监听滚动事件，改变导航栏样式
        window.addEventListener('scroll', () => {
            if (window.scrollY > 10) {
                navbar.classList.add('py-2', 'shadow');
                navbar.classList.remove('py-4', 'shadow-sm');
            } else {
                navbar.classList.add('py-4', 'shadow-sm');
                navbar.classList.remove('py-2', 'shadow');
            }
        });

        // 移动端菜单切换
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // 处理文本按钮点击事件
        processButton.addEventListener('click', processText);
        emptyStateProcessButton.addEventListener('click', () => {
            mixedTextarea.focus();
        });

        // 清空按钮点击事件
        clearButton.addEventListener('click', () => {
            mixedTextarea.value = '';
            mixedTextarea.focus();
            resultsSection.classList.add('hidden');
            sentenceData = [];
            chineseSentences = [];
            updateEmptyState();
        });

        // 模态框控制
        closeModal.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        cancelEdit.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        // 点击模态框外部关闭
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                editModal.classList.add('hidden');
            }
        });

        // 保存编辑
        saveEdit.addEventListener('click', () => {
            const index = parseInt(editSentenceIndex.value);
            if (isNaN(index) || index < 0 || index >= sentenceData.length) {
                return;
            }

            // 更新数据
            sentenceData[index].text = editJapanese.value.trim();
            sentenceData[index].gender = editGender.value;
            chineseSentences[index] = editChinese.value.trim();

            // 重新渲染所有句子卡片
            renderAllSentenceCards();

            // 关闭模态框
            editModal.classList.add('hidden');

            showNotification('句子已更新', 'success');
        });

        // 判断文本是否包含日语字符
        function containsJapanese(text) {
            const japaneseRegex = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]/;
            return japaneseRegex.test(text);
        }

        // 按句号分割句子（。！？）并保留标点符号，也在性别标识处分割
        function splitByPeriod(text) {
            // 先去掉换行符（换行符之间没有真实的空格）
            const cleanedText = text.replace(/\n+/g, '').trim();

            // 先按句号、感叹号、问号分割，但保留标点符号
            let sentences = cleanedText.split(/(?<=[。！？])/);

            // 再按性别标识分割（女: 、男: 、女： 、男：）
            sentences = sentences.flatMap(sentence => {
                return sentence.split(/(?=[女男男女][：:])/);
            });

            return sentences
                .map(s => s.trim())
                .filter(s => s !== '');
        }

        // 提取并去除开头的性别标识
        function extractAndRemoveGenderPrefix(text) {
            const genderMatch = text.match(/^([男女男女])([:：])/);

            if (genderMatch) {
                const gender = genderMatch[1];
                const processedText = text.replace(/^[男女男女][:：]/, '').trim();
                return {
                    text: processedText,
                    gender: gender === '男' || gender === '男' ? 'male' : 'female'
                };
            }

            return {
                text: text.trim(),
                gender: null
            };
        }

        // 查找从指定位置开始的下一个助词位置
        function findNextParticlePosition(text, startPos) {
            // 从起始位置开始检查每个字符
            for (let i = startPos; i < text.length; i++) {
                // 检查当前字符是否是助词
                if (japaneseParticles.includes(text[i])) {
                    return i;
                }

                // 检查是否是双字符助词（如"って"）
                if (i < text.length - 1) {
                    const twoChars = text[i] + text[i + 1];
                    if (japaneseParticles.includes(twoChars)) {
                        return i + 1; // 返回双字符助词的结束位置
                    }
                }
            }

            // 如果没有找到助词，返回文本末尾
            return text.length - 1;
        }

        // 查找从指定位置开始的第N个助词位置
        function findNthParticlePosition(text, startPos, count) {
            let particleCount = 0;
            let lastPosition = startPos;

            // 从起始位置开始检查每个字符
            for (let i = startPos; i < text.length; i++) {
                // 检查当前字符是否是助词
                if (japaneseParticles.includes(text[i])) {
                    particleCount++;
                    lastPosition = i;
                    if (particleCount >= count) {
                        return lastPosition;
                    }
                }

                // 检查是否是双字符助词（如"って"）
                if (i < text.length - 1) {
                    const twoChars = text[i] + text[i + 1];
                    if (japaneseParticles.includes(twoChars)) {
                        particleCount++;
                        lastPosition = i + 1;
                        if (particleCount >= count) {
                            return lastPosition;
                        }
                        i++; // 跳过已处理的第二个字符
                    }
                }
            }

            // 如果找到的助词不足N个，返回文本末尾
            return text.length - 1;
        }

        // 比较文本并记录错误位置
        function compareTexts(userText, originalText) {
            let userHtml = '';
            let correctHtml = '';
            let correctCount = 0;
            let errorPositions = []; // 记录错误位置
            const maxLength = Math.max(userText.length, originalText.length);

            for (let i = 0; i < maxLength; i++) {
                const userChar = i < userText.length ? userText[i] : '';
                const originalChar = i < originalText.length ? originalText[i] : '';

                if (userChar === originalChar && userChar !== '') {
                    // 字符正确
                    userHtml += `<span class="correct-char">${userChar}</span>`;
                    correctHtml += `<span class="correct-char">${originalChar}</span>`;
                    correctCount++;
                } else {
                    // 字符错误，记录位置
                    errorPositions.push(i);

                    if (userChar && originalChar) {
                        // 替换错误
                        userHtml += `<span class="incorrect-char">${userChar}</span>`;
                        correctHtml += `<span class="incorrect-char">${originalChar}</span>`;
                    } else if (userChar && !originalChar) {
                        // 插入错误
                        userHtml += `<span class="extra-char">${userChar}</span>`;
                    } else if (!userChar && originalChar) {
                        // 删除错误
                        userHtml += `<span class="missing-char"> </span>`;
                        correctHtml += `<span class="missing-char">${originalChar}</span>`;
                    }
                }
            }

            const accuracy = originalText.length > 0 ? (correctCount / originalText.length) * 100 : 0;
            const correct = accuracy === 100;

            return {
                userHtml: userHtml,
                correctHtml: correctHtml,
                accuracy: accuracy,
                correct: correct,
                errorPositions: errorPositions
            };
        }

        // 更新对比结果并返回比较结果
        function updateComparisonResult(card, idx) {
            const userInput = card.querySelector('.user-input');
            const checkResult = card.querySelector('.check-result');
            const resultStatus = checkResult.querySelector('.result-status');
            const accuracyDisplay = checkResult.querySelector('.accuracy');
            const userInputDisplay = checkResult.querySelector('.user-input-display');
            const correctAnswerDisplay = checkResult.querySelector('.correct-answer-display');
            const errorPlayButton = card.querySelector('.play-error-button');
            const errorToParticleButton = card.querySelector('.play-error-to-particle-button');
            const shortPlayButton = card.querySelector('.short-play-button');

            const userText = userInput.value.trim();
            const originalText = sentenceData[idx].text;

            if (!userText) {
                showNotification('请先输入内容再播放', 'warning');
                return null;
            }

            // 比较用户输入和原文
            const comparisonResult = compareTexts(userText, originalText);

            // 保存错误位置和范围
            sentenceData[idx].errors = comparisonResult.errorPositions;

            // 计算错误范围
            if (comparisonResult.errorPositions.length > 0) {
                const startPos = Math.min(...comparisonResult.errorPositions);
                const endPos = Math.max(...comparisonResult.errorPositions);
                sentenceData[idx].lastErrorRange = { start: startPos, end: endPos };

                // 计算到助词为止的范围
                const particleEndPos = findNextParticlePosition(originalText, startPos);
                sentenceData[idx].lastErrorToParticleRange = {
                    start: startPos,
                    end: particleEndPos
                };

                // 计算短播放范围（2-3个助词）
                const shortPlayEndPos = findNthParticlePosition(originalText, startPos, 3);
                // 如果内容较短，至少保证2个助词
                if (shortPlayEndPos - startPos < 5) {
                    shortPlayEndPos = findNthParticlePosition(originalText, startPos, 3);
                }
                sentenceData[idx].shortPlayRange = {
                    start: startPos,
                    end: shortPlayEndPos
                };
            }

            // 显示结果区域
            checkResult.classList.remove('hidden');

            // 更新状态和准确率
            resultStatus.innerHTML = comparisonResult.correct ?
                '<span class="text-success"><i class="fa fa-check-circle mr-1"></i>回答正确</span>' :
                '<span class="text-error"><i class="fa fa-times-circle mr-1"></i>有错误</span>';

            accuracyDisplay.textContent = `准确率: ${comparisonResult.accuracy.toFixed(1)}%`;

            // 显示带标记的用户输入和正确答案
            userInputDisplay.innerHTML = comparisonResult.userHtml;
            correctAnswerDisplay.innerHTML = comparisonResult.correctHtml;

            // 根据检查结果显示/隐藏按钮
            if (comparisonResult.correct) {
                errorPlayButton.classList.add('hidden');
                errorToParticleButton.classList.add('hidden');
                shortPlayButton.classList.add('hidden');
            } else {
                errorPlayButton.classList.remove('hidden');
                errorToParticleButton.classList.remove('hidden');
                shortPlayButton.classList.remove('hidden');
            }

            return comparisonResult;
        }

        // 日语朗读函数
        function speakJapanese(text, gender) {
            try {
                // 停止任何正在进行的朗读
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.9; // 稍慢的语速，适合学习

                // 根据性别调整音调和音量
                if (gender === 'male') {
                    utterance.pitch = 0.8; // 降低音调以显得更低沉（男性）
                    utterance.volume = 1.0;
                } else if (gender === 'female') {
                    utterance.pitch = 1.2; // 提高音调以显得更尖锐（女性）
                    utterance.volume = 1.0;
                }

                // 尝试找到合适的语音
                const voices = window.speechSynthesis.getVoices();
                let selectedVoice = null;

                // 筛选日语语音
                const japaneseVoices = voices.filter(voice =>
                    voice.lang.includes('ja') || voice.name.includes('Japanese')
                );

                if (japaneseVoices.length > 0) {
                    // 根据性别选择语音
                    if (gender === 'male') {
                        selectedVoice = japaneseVoices.find(voice =>
                            voice.name.toLowerCase().includes('male') ||
                            voice.name.toLowerCase().includes('man') ||
                            (voice.name.includes('Google') && !voice.name.includes('female'))
                        );
                    } else if (gender === 'female') {
                        selectedVoice = japaneseVoices.find(voice =>
                            voice.name.toLowerCase().includes('female') ||
                            voice.name.toLowerCase().includes('woman') ||
                            voice.name.includes('female')
                        );
                    }

                    // 如果没有找到对应性别的语音，使用第一个日语语音
                    if (!selectedVoice) {
                        selectedVoice = japaneseVoices[0];
                    }

                    utterance.voice = selectedVoice;
                }

                window.speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('语音合成失败:', error);
                showNotification('语音合成功能不可用，请检查浏览器设置', 'error');
            }
        }

        // 渲染所有句子卡片
        function renderAllSentenceCards() {
            sentencesContainer.innerHTML = '';

            sentenceData.forEach((japaneseSentence, index) => {
                const chineseSentence = chineseSentences[index];
                const { text: japaneseText, gender } = japaneseSentence;

                // 性别标识
                let genderBadge = '';
                if (gender === 'male') {
                    genderBadge = '<span class="bg-male/10 text-male text-xs font-medium px-2 py-0.5 rounded ml-2">男性</span>';
                } else if (gender === 'female') {
                    genderBadge = '<span class="bg-female/10 text-female text-xs font-medium px-2 py-0.5 rounded ml-2">女性</span>';
                }

                // 创建句子卡片
                const sentenceCard = document.createElement('div');
                sentenceCard.className = 'bg-white rounded-xl shadow-sm p-6 card-hover border border-neutral-100';
                sentenceCard.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center">
                            <span class="bg-primary/10 text-primary text-sm font-medium px-3 py-1 rounded-full">句子 ${index + 1}</span>
                            ${genderBadge}
                        </div>
                        <div class="flex space-x-2">
                            <button class="play-button text-neutral-500 hover:text-secondary transition-colors p-2 rounded-full hover:bg-secondary/10 focus:outline-none"
                                    data-index="${index}">
                                <i class="fa fa-volume-up text-xl"></i>
                            </button>
                            <button class="toggle-original-button text-neutral-500 hover:text-primary transition-colors p-2 rounded-full hover:bg-primary/10 focus:outline-none"
                                    data-index="${index}">
                                <i class="fa fa-eye text-xl"></i>
                            </button>
                            <button class="edit-button text-neutral-500 hover:text-accent transition-colors p-2 rounded-full hover:bg-accent/10 focus:outline-none"
                                    data-index="${index}">
                                <i class="fa fa-pencil text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 用户输入区域 -->
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-neutral-500 mb-2">请输入你听到的日语</h4>
                        <textarea
                            class="user-input w-full px-4 py-3 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none font-japanese text-lg"
                            rows="2"
                            placeholder="在这里输入你听到的日语..."></textarea>
                        <div class="flex flex-wrap justify-end mt-2 gap-2">
                            <button class="check-button px-4 py-1.5 bg-primary hover:bg-primary/90 text-white rounded-lg shadow-sm hover:shadow transition-all text-sm flex items-center"
                                    data-index="${index}">
                                <i class="fa fa-check mr-1"></i>检查答案
                            </button>
                            <!-- 短播放按钮 - 粉色系 -->
                            <button class="short-play-button px-4 py-1.5 bg-shortPlay/10 text-shortPlay hover:bg-shortPlay hover:text-white rounded-lg shadow-sm hover:shadow transition-all text-sm flex items-center hidden"
                                    data-index="${index}">
                                <i class="fa fa-volume-up mr-1"></i>短播放
                            </button>
                            <!-- 助词按钮 - 青色系 -->
                            <button class="play-error-to-particle-button px-4 py-1.5 bg-particle/10 text-particle hover:bg-particle hover:text-white rounded-lg shadow-sm hover:shadow transition-all text-sm flex items-center hidden"
                                    data-index="${index}">
                                <i class="fa fa-volume-up mr-1"></i>到助词为止
                            </button>
                            <!-- 错误播放按钮 - 紫色系 -->
                            <button class="play-error-button px-4 py-1.5 bg-accent/10 text-accent hover:bg-accent hover:text-white rounded-lg shadow-sm hover:shadow transition-all text-sm flex items-center hidden"
                                    data-index="${index}">
                                <i class="fa fa-volume-up mr-1"></i>从错误处播放
                            </button>
                        </div>
                    </div>

                    <!-- 检查结果区域 -->
                    <div class="check-result hidden mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium result-status"></span>
                            <span class="text-xs text-neutral-500 accuracy"></span>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <span class="text-xs font-medium text-neutral-500">你的输入：</span>
                                <div class="user-input-display font-japanese text-sm p-2 bg-neutral-50 rounded"></div>
                            </div>
                            <div>
                                <span class="text-xs font-medium text-neutral-500">正确答案：</span>
                                <div class="correct-answer-display font-japanese text-sm p-2 bg-neutral-50 rounded"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 日语原文（默认隐藏） -->
                    <div class="japanese-original hidden mb-4">
                        <h4 class="text-sm font-medium text-neutral-500 mb-1">日语原文</h4>
                        <p class="font-japanese text-lg text-neutral-800">${japaneseText}</p>
                    </div>

                    <!-- 中文翻译 -->
                    <div>
                        <h4 class="text-sm font-medium text-neutral-500 mb-1">中文翻译</h4>
                        <p class="text-neutral-700">${chineseSentence}</p>
                    </div>
                `;

                sentencesContainer.appendChild(sentenceCard);

                // 添加朗读按钮事件
                const playBtn = sentenceCard.querySelector('.play-button');
                playBtn.addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    speakJapanese(sentenceData[idx].text, sentenceData[idx].gender);

                    // 按钮动画效果
                    this.classList.add('text-secondary');
                    setTimeout(() => {
                        this.classList.remove('text-secondary');
                    }, 500);
                });

                // 编辑按钮事件
                const editBtn = sentenceCard.querySelector('.edit-button');
                editBtn.addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    const sentence = sentenceData[idx];
                    const chinese = chineseSentences[idx];

                    // 填充编辑表单
                    editSentenceIndex.value = idx;
                    editGender.value = sentence.gender || '';
                    editJapanese.value = sentence.text;
                    editChinese.value = chinese;

                    // 显示模态框
                    editModal.classList.remove('hidden');
                });

                // "到助词为止"按钮事件 - 青色系
                const errorToParticleBtn = sentenceCard.querySelector('.play-error-to-particle-button');
                errorToParticleBtn.addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    const card = this.closest('.bg-white.rounded-xl');

                    // 1. 先更新对比结果
                    const comparisonResult = updateComparisonResult(card, idx);
                    if (!comparisonResult || comparisonResult.correct) {
                        return; // 如果没有结果或回答正确，则不继续
                    }

                    // 2. 获取错误范围
                    const { start, end } = sentenceData[idx].lastErrorToParticleRange;
                    const originalText = sentenceData[idx].text;

                    // 3. 朗读相应部分
                    const playText = originalText.substring(
                        start,
                        Math.min(end + 1, originalText.length)
                    );

                    // 4. 播放
                    speakJapanese(playText, sentenceData[idx].gender);

                    // 按钮动画效果
                    this.classList.add('bg-particleLight', 'text-white');
                    setTimeout(() => {
                        this.classList.remove('bg-particleLight', 'text-white');
                    }, 500);
                });

                // "短播放"按钮事件 - 粉色系
                const shortPlayBtn = sentenceCard.querySelector('.short-play-button');
                shortPlayBtn.addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    const card = this.closest('.bg-white.rounded-xl');

                    // 1. 先更新对比结果
                    const comparisonResult = updateComparisonResult(card, idx);
                    if (!comparisonResult || comparisonResult.correct) {
                        return; // 如果没有结果或回答正确，则不继续
                    }

                    // 2. 获取短播放范围
                    const { start, end } = sentenceData[idx].shortPlayRange;
                    const originalText = sentenceData[idx].text;

                    // 3. 朗读相应部分
                    const playText = originalText.substring(
                        start,
                        Math.min(end + 1, originalText.length)
                    );

                    // 4. 播放
                    speakJapanese(playText, sentenceData[idx].gender);

                    // 按钮动画效果
                    this.classList.add('bg-shortPlayLight', 'text-white');
                    setTimeout(() => {
                        this.classList.remove('bg-shortPlayLight', 'text-white');
                    }, 500);
                });

                // "从错误处播放"按钮事件 - 紫色系
                const errorPlayBtn = sentenceCard.querySelector('.play-error-button');
                errorPlayBtn.addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    const card = this.closest('.bg-white.rounded-xl');

                    // 1. 先更新对比结果
                    const comparisonResult = updateComparisonResult(card, idx);
                    if (!comparisonResult || comparisonResult.correct) {
                        return; // 如果没有结果或回答正确，则不继续
                    }

                    // 2. 获取错误范围
                    const { start, end } = sentenceData[idx].lastErrorRange;
                    const originalText = sentenceData[idx].text;

                    // 3. 朗读相应部分
                    const playText = originalText.substring(
                        start,
                        Math.min(end + 1, originalText.length)
                    );

                    // 4. 播放
                    speakJapanese(playText, sentenceData[idx].gender);

                    // 按钮动画效果
                    this.classList.add('bg-accent', 'text-white');
                    setTimeout(() => {
                        this.classList.remove('bg-accent', 'text-white');
                    }, 500);
                });

                // 显示/隐藏原文按钮事件
                const toggleBtn = sentenceCard.querySelector('.toggle-original-button');
                const originalTxt = sentenceCard.querySelector('.japanese-original');

                toggleBtn.addEventListener('click', function() {
                    originalTxt.classList.toggle('hidden');
                    const icon = this.querySelector('i');
                    if (originalTxt.classList.contains('hidden')) {
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    } else {
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    }
                });

                // 检查按钮事件
                const checkBtn = sentenceCard.querySelector('.check-button');
                checkBtn.addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    const card = this.closest('.bg-white.rounded-xl');

                    // 直接调用更新对比结果的函数
                    updateComparisonResult(card, idx);
                });

                // 监听用户输入变化，显示按钮
                const userInput = sentenceCard.querySelector('.user-input');
                userInput.addEventListener('input', function() {
                    const errorPlayButton = card.querySelector('.play-error-button');
                    const errorToParticleButton = card.querySelector('.play-error-to-particle-button');
                    const shortPlayButton = card.querySelector('.short-play-button');

                    // 只要有输入，就显示按钮
                    if (this.value.trim() !== '') {
                        errorPlayButton.classList.remove('hidden');
                        errorToParticleButton.classList.remove('hidden');
                        shortPlayButton.classList.remove('hidden');
                    } else {
                        errorPlayButton.classList.add('hidden');
                        errorToParticleButton.classList.add('hidden');
                        shortPlayButton.classList.add('hidden');
                    }
                });
            });
        }

        // 处理文本函数
        function processText() {
            try {
                const mixedText = mixedTextarea.value.trim();

                // 验证输入
                if (!mixedText) {
                    showNotification('请输入文本内容', 'warning');
                    mixedTextarea.focus();
                    return;
                }

                // 验证输入不为空
                if (mixedText.length === 0) {
                    showNotification('未检测到有效内容', 'warning');
                    return;
                }

                // 只处理日语句子
                sentenceData = [];
                chineseSentences = [];

                // 直接按句号分割所有文本
                const sentences = splitByPeriod(mixedText);

                sentences.forEach(sentence => {
                    if (sentence.trim() !== '') {
                        const { text: processedText, gender } = extractAndRemoveGenderPrefix(sentence);
                        sentenceData.push({
                            text: processedText,
                            gender: gender,
                            errors: [], // 存储错误位置
                            lastErrorRange: { start: 0, end: 0 }, // 存储上次错误范围
                            lastErrorToParticleRange: { start: 0, end: 0 }, // 存储上次到助词的错误范围
                            shortPlayRange: { start: 0, end: 0 } // 存储短播放范围
                        });
                        // 为每个日语句子添加一个空的中文翻译占位
                        chineseSentences.push('');
                    }
                });

                // 优化：无性别的句子继承前一个句子的性别
                for (let i = 0; i < sentenceData.length; i++) {
                    if (!sentenceData[i].gender && i > 0) {
                        // 向前查找最近的有性的句子
                        for (let j = i - 1; j >= 0; j--) {
                            if (sentenceData[j].gender) {
                                sentenceData[i].gender = sentenceData[j].gender;
                                break;
                            }
                        }
                    }
                }

                // 显示结果区域
                resultsSection.classList.remove('hidden');
                emptyState.classList.add('hidden');

                // 更新句子计数
                sentenceCountElement.textContent = sentenceData.length;

                // 渲染句子卡片
                renderAllSentenceCards();

                // 滚动到练习内容的顶部，考虑导航栏高度
                const practiceContentAnchor = document.getElementById('practice-content');
                if (practiceContentAnchor) {
                    const navbar = document.getElementById('navbar');
                    const navbarHeight = navbar ? navbar.offsetHeight : 0;
                    const elementTop = practiceContentAnchor.getBoundingClientRect().top + window.scrollY;
                    // 减去导航栏高度加一些额外的间距
                    window.scrollTo({
                        top: elementTop - navbarHeight - 20,
                        behavior: 'smooth'
                    });
                }

                showNotification(`已成功处理 ${sentenceData.length} 句日语`, 'success');
            } catch (error) {
                console.error('处理文本时出错:', error);
                showNotification('处理文本时发生错误，请检查输入格式', 'error');
            }
        }

        // 更新空状态显示
        function updateEmptyState() {
            if (mixedTextarea.value.trim() === '' && resultsSection.classList.contains('hidden')) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }
        }

        // 显示通知函数
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');

            let bgColor, icon;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    icon = 'fa-check-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    icon = 'fa-exclamation-triangle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    icon = 'fa-times-circle';
                    break;
                default:
                    bgColor = 'bg-primary';
                    icon = 'fa-info-circle';
            }

            notification.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-10 opacity-0 z-50 flex items-center`;
            notification.innerHTML = `
                <i class="fa ${icon} mr-2"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            // 显示动画
            setTimeout(() => {
                notification.classList.remove('translate-y-10', 'opacity-0');
            }, 10);

            // 自动消失
            setTimeout(() => {
                notification.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 监听文本输入，更新空状态
        mixedTextarea.addEventListener('input', updateEmptyState);

        // 初始化语音合成
        window.speechSynthesis.onvoiceschanged = function() {
            console.log('语音合成已准备就绪');
        };

        // 预填充示例文本
        mixedTextarea.value = `大学の演劇サ一クルで女の学生と部長の男の学生が話しています。女の学生はこの後何
をしなければなりませんか。
女:鈴木さん。来週の新入生勧誘のためのサ一クル体験会、ポスタ一を見た人から早速
参加の申し込みが来てますね。
男:うん、準備進めないとね。当日来てくれた人には演劇を一部実際に体験してもらう
よね？その時に使うシ一ン、台本から候補選ぶのお願いしてたけど、どう?
女:はい。体験者が多くても使えそうなシンを3つピックアップしました。
男:じゃ、その中から僕が選んでセリフを印刷しておくよ。あと当日は受付とか誘導と
かみんなにも手伝ってもらうから誰が何を担当するか割り振ってほしいんだ。
女:わかりました。えっと、当日配る入部案内のチラシの準備は?
男：ああ、それは2年生に印刷してもらおうと思ってるんだ。僕から頼んでおくよ。
女：わかりました。
女の学生はこの後何をしなければなりませんか。`;

        // 页面加载完成后自动处理文本
        setTimeout(() => {
            processText();
            // // 页面加载完成后自动回到顶部
            // window.scrollTo(0, 0);
        }, 500);
    </script>
</body>
</html>